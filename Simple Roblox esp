-- Get necessary services from Roblox
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Table to hold ESP boxes and line connections associated with players' characters
local espBoxes = {}
local lineConnections = {}

-- Function to create an ESP box around a player's character
local function createESPBox(character)
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end -- Ensure the HumanoidRootPart exists

    -- Create a Box Handle Adornment
    local espBox = Instance.new("BoxHandleAdornment")
    espBox.Size = Vector3.new(4, 6, 2) -- Size of the ESP box
    espBox.Color3 = Color3.new(0, 0, 1) -- Color of the ESP box (blue)
    espBox.Transparency = 0.5 -- Semi-transparent
    espBox.ZIndex = 10
    espBox.Adornee = humanoidRootPart
    espBox.AlwaysOnTop = true -- Important to make it visible through walls
    espBox.Parent = humanoidRootPart -- Attach to HumanoidRootPart

    espBoxes[character] = espBox -- Store the ESP box for cleanup
end

-- Function to create a line between two points
local function createLine(from, to)
    local line = Instance.new("LineHandleAdornment")
    line.Length = (to - from).magnitude -- Set the line length accordingly
    line.Color3 = Color3.new(1, 0, 0) -- Color of the line (red)
    line.Transparency = 0 -- Fully visible
    line.ZIndex = 10
    line.AlwaysOnTop = true

    -- Set the points for the line
    line.PointA = from
    line.PointB = to
    line.Parent = Workspace

    table.insert(lineConnections, line) -- Store line for cleanup
end

-- Function to update line connections
local function updateLineConnections()
    -- Clean up existing lines
    for _, line in ipairs(lineConnections) do
        if line then
            line:Destroy()
        end
    end
    lineConnections = {}

    local players = Players:GetPlayers()
    for i = 1, #players do
        local playerA = players[i]
        if not playerA.Character or not playerA.Character:FindFirstChild("HumanoidRootPart") then continue end
        local rootA = playerA.Character.HumanoidRootPart
        
        for j = i + 1, #players do
            local playerB = players[j]
            if not playerB.Character or not playerB.Character:FindFirstChild("HumanoidRootPart") then continue end
            local rootB = playerB.Character.HumanoidRootPart
            
            -- Create a ray between the two HumanoidRootParts
            local direction = (rootB.Position - rootA.Position).unit
            local distance = (rootB.Position - rootA.Position).magnitude
            local ray = Ray.new(rootA.Position, direction * distance)
            local hit = Workspace:Raycast(ray.Origin, ray.Direction * distance)

            -- Ensure the line is drawn only if the ray does not hit the other player
            if not hit or not hit.Instance:IsDescendantOf(playerB.Character) then
                createLine(rootA.Position, rootB.Position) 
            end
        end
    end
end

-- Function to clean up the ESP box and lines when a character is removed
local function cleanupESP(character)
    local espBox = espBoxes[character]
    if espBox then
        espBox:Destroy()
        espBoxes[character] = nil
    end
end

-- Function to set up ESP for each player
local function setupESPForPlayer(player)
    player.CharacterAdded:Connect(function(character)
        wait(1) -- Slight delay to ensure the character is fully loaded
        createESPBox(character)

        local humanoid = character:WaitForChild("Humanoid", 5) -- Wait for humanoid
        if humanoid then
            humanoid.Died:Connect(function()
                cleanupESP(character)
            end)
        end

        character.AncestryChanged:Connect(function(_, parent)
            if not parent then
                cleanupESP(character)
            end
        end)
    end)

    -- If the character already exists, create the ESP box immediately
    if player.Character then
        createESPBox(player.Character)

        local humanoid = player.Character:WaitForChild("Humanoid", 5) -- Wait for humanoid
        if humanoid then
            humanoid.Died:Connect(function()
                cleanupESP(player.Character)
            end)
        end

        player.Character.AncestryChanged:Connect(function(_, parent)
            if not parent then
                cleanupESP(player.Character)
            end
        end)
    end
end

-- Initialize ESP for all current players already in the game
for _, player in ipairs(Players:GetPlayers()) do
    setupESPForPlayer(player)
end

-- Handle new players that join the game
Players.PlayerAdded:Connect(setupESPForPlayer)

-- Update line connections every frame
RunService.RenderStepped:Connect(updateLineConnections)
